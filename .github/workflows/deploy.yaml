# ============================================================================
# GCP WORKLOADS DEPLOYMENT PIPELINE
# ============================================================================
# Mirrors the landing zone pipeline pattern exactly:
#   Stage 1: terraform-plan — runs automatically on push to main
#   Stage 2: terraform-apply — waits for manual approval via environment gate
#
# Authentication: Workload Identity Federation — no credentials stored
# Workloads Terraform files live under the terraform/ subdirectory

name: Deploy Workloads

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/648099970996/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "terraform-sa@project-5a757d72-eb26-477c-bd9.iam.gserviceaccount.com"

      - uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -var="db_password=${{ secrets.DB_PASSWORD }}"
        env:
          TF_VAR_billing_account: ${{ secrets.TF_BILLING_ACCOUNT }}

      # Cluster does not exist on first run — fails gracefully
      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials workloads-gke-001 \
            --region europe-west1 \
            --project prod-workloads-lz-001
        continue-on-error: true

      - name: Kubectl Diff
        run: kubectl diff -f kubernetes/ || true
        continue-on-error: true

  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: production

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/648099970996/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "terraform-sa@project-5a757d72-eb26-477c-bd9.iam.gserviceaccount.com"

      - uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -var="db_password=${{ secrets.DB_PASSWORD }}" -auto-approve
        env:
          TF_VAR_billing_account: ${{ secrets.TF_BILLING_ACCOUNT }}

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials workloads-gke-001 \
            --region europe-west1 \
            --project prod-workloads-lz-001

      - name: Create Database Secret
        run: |
          kubectl create secret generic db-credentials \
            --from-literal=password=${{ secrets.DB_PASSWORD }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Kubernetes Service Account
        run: kubectl apply -f kubernetes/api/serviceaccount.yaml

      - name: Apply ConfigMaps
        run: |
          kubectl apply -f kubernetes/frontend/configmap.yaml
          kubectl apply -f kubernetes/api/configmap.yaml

      - name: Apply Frontend Manifests
        run: kubectl apply -f kubernetes/frontend/

      - name: Apply API Manifests
        run: kubectl apply -f kubernetes/api/

      - name: Wait for Frontend Rollout
        run: kubectl rollout status deployment/frontend --timeout=300s

      - name: Wait for API Rollout
        run: kubectl rollout status deployment/api --timeout=300s

      - name: Print Deployment Status
        run: |
          echo "=============================="
          echo "NODES"
          echo "=============================="
          kubectl get nodes

          echo ""
          echo "=============================="
          echo "PODS"
          echo "=============================="
          kubectl get pods -o wide

          echo ""
          echo "=============================="
          echo "SERVICES"
          echo "=============================="
          kubectl get services

          echo ""
          echo "=============================="
          echo "FRONTEND PUBLIC IP"
          echo "=============================="
          kubectl get service frontend-service \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}'