# ============================================================================
# KUBERNETES SERVICE ACCOUNT â€” CLOUD SQL PROXY
# ============================================================================
# This Kubernetes service account is bound to the GCP service account
# (cloudsql-proxy-sa) via Workload Identity.
#
# HOW WORKLOAD IDENTITY WORKS:
# 1. This k8s service account is annotated with the GCP SA email
# 2. The GKE metadata server intercepts token requests from the pod
# 3. It exchanges the k8s token for a GCP token scoped to cloudsql-proxy-sa
# 4. The Cloud SQL proxy uses that GCP token to authenticate to Cloud SQL
# 5. No keys, no secrets, no rotation needed
#
# AWS equivalent: Kubernetes service account annotated with
# eks.amazonaws.com/role-arn for IRSA (IAM Roles for Service Accounts)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s-cloudsql-proxy
  namespace: default
  annotations:
    # This annotation is what links k8s identity to GCP identity
    iam.gke.io/gcp-service-account: "cloudsql-proxy-sa@prod-workloads-lz-001.iam.gserviceaccount.com"